name: Release

on:
    push:
        tags:
            - "v*"
    workflow_dispatch:

permissions:
    contents: read

jobs:
    publish:
        runs-on: ubuntu-latest
        timeout-minutes: 20
        permissions:
            contents: write
            id-token: write
        concurrency:
            group: release-${{ github.ref }}
            cancel-in-progress: false

        steps:
            - name: Harden the runner (Audit all outbound calls)
              uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
              with:
                  egress-policy: audit

            - name: Checkout
              uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
              with:
                  fetch-depth: 0
                  fetch-tags: true

            - name: Setup Node.js
              uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
              with:
                  node-version: 20.19.0
                  registry-url: "https://registry.npmjs.org"
                  cache: npm

            - name: Install dependencies
              run: npm ci --force

            - name: Validate tag matches package version
              if: startsWith(github.ref, 'refs/tags/v')
              run: |
                  TAG_VERSION="${GITHUB_REF_NAME#v}"
                  PACKAGE_VERSION=$(node -p "require('./package.json').version")
                  if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
                    echo "Tag version ($TAG_VERSION) does not match package.json version ($PACKAGE_VERSION)."
                    exit 1
                  fi

            - name: Verify package
              run: npm run release:check

            - name: Generate release notes from git-cliff
              if: startsWith(github.ref, 'refs/tags/v')
              shell: bash
              run: |
                  mkdir -p temp
                  npm run changelog:release-notes -- > temp/release-notes.md
                  if [ ! -s temp/release-notes.md ]; then
                    echo "No release notes were generated by git-cliff." > temp/release-notes.md
                  fi

            - name: Publish to npm
              if: startsWith(github.ref, 'refs/tags/v')
              run: npm publish --access public --provenance
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            - name: Create GitHub release
              if: startsWith(github.ref, 'refs/tags/v')
              uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
              with:
                  body_path: temp/release-notes.md
                  generate_release_notes: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
